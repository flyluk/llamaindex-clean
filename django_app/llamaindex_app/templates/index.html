{% extends 'base.html' %}

{% block content %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 200px);
    }
    .chat-messages-wrapper {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #30363d;
        border-radius: 6px;
        padding: 15px;
        background-color: #0d1117;
        margin-bottom: 15px;
    }
    .chat-input-wrapper {
        position: sticky;
        bottom: 0;
        background-color: #161b22;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #30363d;
        z-index: 100;
    }
</style>

<div class="row">
    <div class="col-md-8">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>üîç Search Documents</h2>
            <button class="btn btn-outline-secondary btn-sm" onclick="clearChatHistory()">Clear Chat</button>
        </div>
        
        <div class="chat-container">
            <!-- Chat Messages -->
            <div id="chatMessages" class="chat-messages-wrapper">
                <div class="text-center text-muted">
                    <i class="bi bi-chat-dots"></i> Start a conversation
                </div>
            </div>
            
            <!-- Fixed Input Area -->
            <div class="chat-input-wrapper">
                <form id="searchForm">
                    {% csrf_token %}
                    <div class="mb-2">
                        <input type="text" class="form-control" name="query" placeholder="What are you looking for?" required>
                    </div>
                    <div class="d-flex gap-2 align-items-center flex-wrap">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="useDirectVector" name="use_direct_vector">
                            <label class="form-check-label" for="useDirectVector">
                                ‚ö° Vector only
                            </label>
                        </div>
                        <select class="form-select" id="topKSelect" name="top_k" style="width: auto;">
                            <option value="3">Top 3</option>
                            <option value="5">Top 5</option>
                            <option value="10" selected>Top 10</option>
                            <option value="20">Top 20</option>
                            <option value="50">Top 50</option>
                        </select>
                        <button type="submit" class="btn btn-primary ms-auto">Search</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <h4>üìÅ Upload Documents</h4>
        <form id="uploadForm">
            {% csrf_token %}
            <div class="mb-3">
                <input type="file" class="form-control" id="fileInput" name="files" multiple accept=".pdf,.txt,.md,.docx,.doc">
            </div>
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="useSentenceSplitter" name="use_sentence_splitter">
                    <label class="form-check-label" for="useSentenceSplitter">
                        üìù Use sentence splitter (default: structure extraction)
                    </label>
                </div>
            </div>
            <button type="submit" class="btn btn-success" id="uploadBtn">Upload & Process</button>
        </form>
        
        <div id="uploadProgress" class="mt-3 text-center" style="display:none;">
            <div class="spinner-border text-primary mb-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div><small class="text-muted" id="progressText">Processing files...</small></div>
        </div>
        
        <!-- Model Selection Section -->
        <div class="mt-4">
            <h5>ü§ñ Model Selection</h5>
            {% if is_azure %}
                <div class="alert alert-info">
                    <i class="bi bi-cloud"></i> Azure endpoint detected<br>
                    <strong>Model:</strong> {{ config.default_model }}
                </div>
            {% else %}
                <div class="mb-3">
                    <select class="form-select" id="modelSelect">
                        {% for model in installed_models %}
                            <option value="{{ model }}" {% if model == config.default_model %}selected{% endif %}>
                                {{ model }}
                            </option>
                        {% endfor %}
                    </select>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="changeModel()">Change Model</button>
                </div>
                <div class="mb-3">
                    <label for="contextSelect" class="form-label">üß† Context Length:</label>
                    <div class="d-flex gap-2">
                        <select class="form-select" id="contextSelect" name="context_length">
                            <option value="8192" {% if config.context_length == 8192 %}selected{% endif %}>8K</option>
                            <option value="16384" {% if config.context_length == 16384 %}selected{% endif %}>16K</option>
                            <option value="24576" {% if config.context_length == 24576 %}selected{% endif %}>24K</option>
                            <option value="32768" {% if config.context_length == 32768 %}selected{% endif %}>32K</option>
                            <option value="49152" {% if config.context_length == 49152 %}selected{% endif %}>48K</option>
                            <option value="65536" {% if config.context_length == 65536 %}selected{% endif %}>64K</option>
                            <option value="131072" {% if config.context_length == 131072 %}selected{% endif %}>128K</option>
                        </select>
                        <button class="btn btn-sm btn-outline-primary" onclick="saveContextLength()">Save</button>
                    </div>
                </div>
            {% endif %}
        </div>
        
        <!-- Knowledge Status Section -->
        <div class="mt-4">
            <h5>üìä Knowledge Status</h5>
            {% if knowledge_status %}
                {% if knowledge_status.error %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> {{ knowledge_status.error }}
                    </div>
                {% else %}
                    <div class="card">
                        <div class="card-body">
                            <p><strong>Database:</strong> {{ knowledge_status.db_path|truncatechars:50 }}</p>
                            <p><strong>Model:</strong> {{ knowledge_status.model }}</p>
                            <p><strong>Documents:</strong> {{ knowledge_status.doc_count }}</p>
                            <p><strong>Processed Files:</strong> {{ knowledge_status.processed_files_count }}</p>
                            <p><strong>Completed Files:</strong> {{ knowledge_status.completed_files_count }}</p>
                            
                            <hr>
                            <h6>üîß Vector Database Info</h6>
                            {% if knowledge_status.vector_info.error %}
                                <p class="text-warning">Error: {{ knowledge_status.vector_info.error }}</p>
                            {% else %}
                                <p><strong>Dimension:</strong> {{ knowledge_status.vector_info.dimension|default:"Unknown" }}</p>
                                <p><strong>Collection:</strong> {{ knowledge_status.vector_info.collection_name|default:"Unknown" }}</p>
                                <p><strong>Total Vectors:</strong> {{ knowledge_status.vector_info.total_documents|default:"0" }}</p>
                                <p><strong>Embed Model:</strong> {{ knowledge_status.vector_info.embed_model|default:"Unknown" }}</p>
                                <p><strong>Embed URL:</strong> {{ knowledge_status.vector_info.embed_url|truncatechars:40|default:"Unknown" }}</p>
                                <p><strong>ChromaDB:</strong> {{ knowledge_status.vector_info.chroma_version|default:"Unknown" }}</p>
                                <p><strong>Client:</strong> {{ knowledge_status.vector_info.client_type|default:"Unknown" }}</p>
                            {% endif %}
                            
                            {% if knowledge_status.files %}
                                <hr>
                                <details class="mt-2">
                                    <summary><strong>Files ({{ knowledge_status.files|length }})</strong></summary>
                                    <div class="mt-2">
                                        {% for file in knowledge_status.files %}
                                            <div class="d-flex justify-content-between align-items-center py-1">
                                                <span class="text-truncate">{{ file.name }}</span>
                                                <div class="d-flex align-items-center gap-2">
                                                    <span class="badge {% if file.completed %}bg-success{% else %}bg-warning{% endif %}">
                                                        {% if file.completed %}‚úÖ Complete{% else %}‚ö†Ô∏è Partial{% endif %}
                                                    </span>
                                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteFile('{{ file.path }}')"
                                                            title="Delete file from database">
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </details>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<script>
// Chat history management
let chatHistory = [];

function formatChatHistory() {
    return chatHistory.map(msg => {
        const role = msg.role === 'user' ? 'User' : 'Assistant';
        return `${role}: ${msg.content}`;
    }).join('\n');
}

function addToChatHistory(role, content, responseTime) {
    chatHistory.push({ role, content, responseTime });
    if (chatHistory.length > 20) { // Keep last 20 messages
        chatHistory = chatHistory.slice(-20);
    }
    updateChatHistoryDisplay();
}

function updateChatHistoryDisplay() {
    const chatDiv = $('#chatMessages');
    
    if (chatHistory.length === 0) {
        chatDiv.html('<div class="text-center text-muted"><i class="bi bi-chat-dots"></i> Start a conversation</div>');
        return;
    }
    
    chatDiv.empty();
    
    chatHistory.forEach(msg => {
        const isUser = msg.role === 'user';
        const timeInfo = !isUser && msg.responseTime ? `<span class="text-muted ms-2">‚è±Ô∏è ${msg.responseTime}s</span>` : '';
        const messageDiv = $(`
            <div class="d-flex ${isUser ? 'justify-content-end' : 'justify-content-start'} mb-3">
                <div class="${isUser ? 'bg-primary' : ''} text-white p-3 rounded ${isUser ? 'user-message-clickable' : ''}" style="max-width: 80%; word-wrap: break-word; ${isUser ? 'cursor: pointer;' : ''} ${isUser ? '' : 'background-color: #21262d; border: 1px solid #30363d;'}">
                    <div class="small mb-1">${isUser ? 'You' : 'Assistant'}${timeInfo}</div>
                    <div class="markdown-content">${isUser ? msg.content : marked.parse(msg.content)}</div>
                </div>
            </div>
        `);
        
        if (isUser) {
            messageDiv.find('.user-message-clickable').click(function() {
                $('input[name="query"]').val(msg.content);
            });
        }
        
        chatDiv.append(messageDiv);
    });
    
    // Scroll to bottom
    chatDiv[0].scrollTop = chatDiv[0].scrollHeight;
}

function clearChatHistory() {
    chatHistory = [];
    updateChatHistoryDisplay();
}

function generateFollowUpPrompts(query, response) {
    // Add loading indicator for follow-up prompts
    const followUpLoadingId = 'followup-loading-' + Date.now();
    const loadingDiv = $(`
        <div class="d-flex justify-content-start mb-3" id="${followUpLoadingId}">
            <div class="text-white p-3 rounded" style="max-width: 80%; background-color: #161b22; border: 1px solid #30363d;">
                <div class="small mb-2 text-muted">üí° Generating follow-up questions...</div>
                <div class="spinner-border spinner-border-sm" role="status"></div>
            </div>
        </div>
    `);
    $('#chatMessages').append(loadingDiv);
    $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
    
    // Call LLM to generate follow-up prompts
    $.post('/generate-followup/', {
        'query': query,
        'response': response,
        'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
    }, function(data) {
        $(`#${followUpLoadingId}`).remove();
        
        if (data.success && data.prompts && data.prompts.length > 0) {
            const followUpDiv = $(`
                <div class="d-flex justify-content-start mb-3">
                    <div class="text-white p-3 rounded" style="max-width: 80%; background-color: #161b22; border: 1px solid #30363d;">
                        <div class="small mb-2 text-muted">üí° Follow-up questions:</div>
                        <div class="d-flex flex-wrap gap-2">
                            ${data.prompts.map(p => `<button class="btn btn-sm btn-outline-primary follow-up-btn" onclick="useFollowUp('${p.replace(/'/g, "\\'")}')">üìù ${p}</button>`).join('')}
                        </div>
                    </div>
                </div>
            `);
            
            $('#chatMessages').append(followUpDiv);
            $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
        }
    }).fail(function() {
        $(`#${followUpLoadingId}`).remove();
    });
}

window.useFollowUp = function(prompt) {
    $('input[name="query"]').val(prompt);
    $('input[name="query"]').focus();
}

$('#searchForm').submit(function(e) {
    e.preventDefault();
    const query = $('input[name="query"]').val();
    const startTime = Date.now();
    
    // Add user message immediately
    addToChatHistory('user', query);
    
    // Add loading message
    const loadingId = 'loading-' + Date.now();
    const loadingDiv = $(`
        <div class="d-flex justify-content-start mb-3" id="${loadingId}">
            <div class="text-white p-3 rounded" style="max-width: 80%; background-color: #21262d; border: 1px solid #30363d;">
                <div class="small mb-1">Assistant</div>
                <div><i class="bi bi-hourglass-split"></i> Searching...</div>
            </div>
        </div>
    `);
    $('#chatMessages').append(loadingDiv);
    $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
    
    const chatHistoryText = formatChatHistory();
    
    $.post('/search/', {
        'query': query,
        'use_direct_vector': $('#useDirectVector').is(':checked'),
        'top_k': $('#topKSelect').val(),
        'context_length': $('#contextSelect').val(),
        'chat_history': chatHistoryText,
        'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
    }, function(data) {
        // Remove loading message
        $(`#${loadingId}`).remove();
        
        if (data.success) {
            // Calculate response time
            const responseTime = ((Date.now() - startTime) / 1000).toFixed(2);
            
            // Add assistant response with time
            addToChatHistory('assistant', data.result, responseTime);
            
            // Generate and add follow-up prompts
            generateFollowUpPrompts(query, data.result);
            
            // Add to search history
            const kb = $('input[name="kb_selection"]:checked').val() || 'default';
            const model = '{{ config.default_model }}';
            addToHistory(query, data.result, kb, model, chatHistoryText);
        } else {
            addToChatHistory('assistant', `Error: ${data.error}`);
        }
        
        // Clear input
        $('input[name="query"]').val('');
    }).fail(function() {
        $(`#${loadingId}`).remove();
        addToChatHistory('assistant', 'Connection error. Please try again.');
    });
});

$('#uploadForm').submit(function(e) {
    e.preventDefault();
    const fileInput = $('#fileInput')[0];
    
    if (!fileInput.files.length) {
        alert('Please select files to upload');
        return;
    }
    
    const formData = new FormData();
    for (let i = 0; i < fileInput.files.length; i++) {
        formData.append('files', fileInput.files[i]);
    }
    formData.append('use_sentence_splitter', $('#useSentenceSplitter').is(':checked'));
    formData.append('csrfmiddlewaretoken', $('[name=csrfmiddlewaretoken]').val());
    
    $('#uploadBtn').prop('disabled', true).text('Processing...');
    $('#uploadProgress').show();
    $('#progressText').text('Processing files...');
    
    $.ajax({
        url: '/upload/',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,

        success: function(data) {
            $('#progressText').text('Upload completed successfully!');
            setTimeout(() => {
                $('#uploadProgress').hide();
                $('#uploadBtn').prop('disabled', false).text('Upload & Process');
                $('#fileInput').val('');
                location.reload();
            }, 2000);
        },
        error: function() {
            $('#progressText').text('Upload failed. Please try again.');
            $('#uploadBtn').prop('disabled', false).text('Upload & Process');
            $('#uploadProgress').hide();
        }
    });
});

// Function to show history result
window.showHistoryResult = function(query, result, kb, model, savedChatHistory) {
    // Restore chat history if available
    if (savedChatHistory) {
        chatHistory = [];
        savedChatHistory.split('\n').forEach(line => {
            if (line.startsWith('User: ')) {
                chatHistory.push({ role: 'user', content: line.substring(6) });
            } else if (line.startsWith('Assistant: ')) {
                chatHistory.push({ role: 'assistant', content: line.substring(11) });
            }
        });
        updateChatHistoryDisplay();
    }
    
    // Add history info message
    addToChatHistory('assistant', `üìú *From history - KB: ${kb}, Model: ${model}*\n\n${result}`);
};

// Function to delete file
window.deleteFile = function(filePath) {
    if (!confirm('Are you sure you want to delete this file from the database?')) {
        return;
    }
    
    $.post('/delete_file/', {
        'file_path': filePath,
        'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
    }, function(data) {
        if (data.success) {
            alert('File deleted successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    }).fail(function() {
        alert('Connection error. Please try again.');
    });
};

// Function to change model (only for non-Azure)
window.changeModel = function() {
    const selectedModel = $('#modelSelect').val();
    
    $.post('/change-model/', {
        'model': selectedModel,
        'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
    }, function(data) {
        if (data.success) {
            alert('Model changed successfully!');
            location.reload();
        } else {
            alert('Error changing model');
        }
    }).fail(function() {
        alert('Connection error. Please try again.');
    });
};

// Function to save context length
window.saveContextLength = function() {
    const contextLength = $('#contextSelect').val();
    
    $.post('/update-config/', {
        'context_length': contextLength,
        'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
    }, function(data) {
        if (data.success) {
            alert('Context length saved successfully!');
        } else {
            alert('Error saving context length');
        }
    }).fail(function() {
        alert('Connection error. Please try again.');
    });
};
</script>
{% endblock %}