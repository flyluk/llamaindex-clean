{% extends 'base.html' %}

{% block content %}
<h2>ü§ñ Ollama Models</h2>

<button class="btn btn-primary mb-3" onclick="location.reload()">üîÑ Refresh Models</button>

<div class="row">
    <div class="col-md-6">
        <h4>üì• Available Models</h4>
        {% for model in library_models %}
        <div class="border-bottom py-2">
            <div class="d-flex justify-content-between align-items-center">
                <span>
                    {{ model }} - 
                    {% if model in installed_models %}
                        ‚úÖ Installed
                    {% else %}
                        ‚¨áÔ∏è Available
                    {% endif %}
                </span>
                {% if model not in installed_models %}
                <button class="btn btn-sm btn-outline-primary" onclick="pullModel('{{ model }}', this)">Pull</button>
                {% endif %}
            </div>
            {% if model not in installed_models %}
            <div class="mt-2" id="loading-{{ model|cut:':' }}" style="display: none;">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <small class="text-muted ms-2">Pulling model...</small>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    <div class="col-md-6">
        <h4>üìã Installed Models</h4>
        {% for model in installed_models %}
        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
            <span>‚úÖ {{ model }}</span>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteModel('{{ model }}')">Delete</button>
        </div>
        {% endfor %}
    </div>
</div>

<script>
function pullModel(modelName, buttonElement) {
    if (confirm(`Pull model ${modelName}?`)) {
        const button = $(buttonElement);
        const container = button.closest('.border-bottom');
        const loading = container.find('[id^="loading-"]');
        
        button.prop('disabled', true).text('Pulling...');
        loading.show();
        
        $.post('/pull_model/', {
            'model_name': modelName,
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        }, function(data) {
            if (data.success) {
                loading.find('small').text('Complete!');
                setTimeout(() => location.reload(), 1000);
            } else {
                button.prop('disabled', false).text('Pull');
                loading.hide();
                alert('Error: ' + data.error);
            }
        });
    }
}

function deleteModel(modelName) {
    if (confirm(`Delete model ${modelName}?`)) {
        $.post('/delete_model/', {
            'model_name': modelName,
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        }, function(data) {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}
</script>
{% csrf_token %}
{% endblock %}