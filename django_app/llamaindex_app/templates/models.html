{% extends 'base.html' %}

{% block content %}
<h2>ü§ñ Ollama Models</h2>

<button class="btn btn-primary mb-3" onclick="location.reload()">üîÑ Refresh Models</button>

<div class="row">
    <div class="col-md-6">
        <h4>üì• Available Models</h4>
        {% for model in library_models %}
        <div class="border-bottom py-2">
            <div class="d-flex justify-content-between align-items-center">
                <span>
                    {{ model }} - 
                    {% if model in installed_models %}
                        ‚úÖ Installed
                    {% else %}
                        ‚¨áÔ∏è Available
                    {% endif %}
                </span>
                {% if model not in installed_models %}
                <button class="btn btn-sm btn-outline-primary" onclick="pullModel('{{ model }}', this)">Pull</button>
                {% endif %}
            </div>
            {% if model not in installed_models %}
            <div class="progress mt-2" id="progress-{{ model|cut:':' }}" style="display: none;">
                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
            <small class="text-muted" id="status-{{ model|cut:':' }}" style="display: none;"></small>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    <div class="col-md-6">
        <h4>üìã Installed Models</h4>
        {% for model in installed_models %}
        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
            <span>‚úÖ {{ model }}</span>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteModel('{{ model }}')">Delete</button>
        </div>
        {% endfor %}
    </div>
</div>

<script>
function pullModel(modelName, buttonElement) {
    if (confirm(`Pull model ${modelName}?`)) {
        const button = $(buttonElement);
        const container = button.closest('.border-bottom');
        const progress = container.find('.progress');
        const status = container.find('.text-muted');
        
        button.prop('disabled', true).text('Pulling...');
        progress.show();
        status.show().text('Starting...');
        
        $.post('/pull_model/', {
            'model_name': modelName,
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        }, function(data) {
            if (data.success) {
                progress.find('.progress-bar').css('width', '100%');
                status.text('Complete!');
                setTimeout(() => location.reload(), 1000);
            } else {
                button.prop('disabled', false).text('Pull');
                progress.hide();
                status.hide();
                alert('Error: ' + data.error);
            }
        });
    }
}

function deleteModel(modelName) {
    if (confirm(`Delete model ${modelName}?`)) {
        $.post('/delete_model/', {
            'model_name': modelName,
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        }, function(data) {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}
</script>
{% csrf_token %}
{% endblock %}