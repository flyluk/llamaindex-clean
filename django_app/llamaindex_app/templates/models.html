{% extends 'base.html' %}

{% block content %}
<h2>ü§ñ Ollama Models</h2>

<button class="btn btn-primary mb-3" onclick="location.reload()">üîÑ Refresh Models</button>

<div class="card mb-4">
    <div class="card-header">
        üì• Pull Custom Model
    </div>
    <div class="card-body">
        <div class="input-group">
            <input type="text" class="form-control" id="customModelName" placeholder="Enter model name (e.g., llama3.2:1b)">
            <button class="btn btn-success" onclick="pullCustomModel()">üì• Pull Model</button>
        </div>
        <div class="mt-2" id="customModelLoading" style="display: none;">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <small class="text-muted ms-2">Pulling custom model...</small>
        </div>
        <small class="text-muted">Enter any Ollama model name to pull and add to library</small>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <h4>üì• Available Models</h4>
        {% for model in library_models %}
        <div class="border-bottom py-2">
            <div class="d-flex justify-content-between align-items-center">
                <span>
                    {{ model }} - 
                    {% if model in installed_models %}
                        ‚úÖ Installed
                    {% else %}
                        ‚¨áÔ∏è Available
                    {% endif %}
                </span>
                {% if model not in installed_models %}
                <button class="btn btn-sm btn-outline-primary" onclick="pullModel('{{ model }}', this)">Pull</button>
                {% endif %}
            </div>
            {% if model not in installed_models %}
            <div class="mt-2" id="loading-{{ model|cut:':' }}" style="display: none;">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <small class="text-muted ms-2">Pulling model...</small>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    <div class="col-md-6">
        <h4>üìã Installed Models</h4>
        {% for model in installed_models %}
        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
            <span>‚úÖ {{ model }}</span>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteModel('{{ model }}')">Delete</button>
        </div>
        {% endfor %}
    </div>
</div>

<script>
function pullModel(modelName, buttonElement) {
    if (confirm(`Pull model ${modelName}?`)) {
        const button = $(buttonElement);
        const container = button.closest('.border-bottom');
        const loading = container.find('[id^="loading-"]');
        
        button.prop('disabled', true).text('Pulling...');
        loading.show();
        
        $.post('/pull_model/', {
            'model_name': modelName,
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        }, function(data) {
            if (data.success) {
                loading.find('small').text('Complete!');
                setTimeout(() => location.reload(), 1000);
            } else {
                button.prop('disabled', false).text('Pull');
                loading.hide();
                alert('Error: ' + data.error);
            }
        });
    }
}

function deleteModel(modelName) {
    if (confirm(`Delete model ${modelName}?`)) {
        $.post('/delete_model/', {
            'model_name': modelName,
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        }, function(data) {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

function pullCustomModel() {
    const modelName = $('#customModelName').val().trim();
    if (!modelName) {
        alert('Please enter a model name');
        return;
    }
    
    if (confirm(`Pull custom model ${modelName}?`)) {
        $('#customModelName').prop('disabled', true);
        $('button[onclick="pullCustomModel()"]').prop('disabled', true).text('üì• Pulling...');
        $('#customModelLoading').show();
        
        $.post('/pull_custom_model/', {
            'model_name': modelName,
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        }, function(data) {
            $('#customModelLoading').hide();
            if (data.success) {
                alert(`Successfully pulled ${modelName} and added to library!`);
                location.reload();
            } else {
                alert('Error: ' + data.error);
                $('#customModelName').prop('disabled', false);
                $('button[onclick="pullCustomModel()"]').prop('disabled', false).text('üì• Pull Model');
            }
        }).fail(function() {
            $('#customModelLoading').hide();
            alert('Connection error. Please try again.');
            $('#customModelName').prop('disabled', false);
            $('button[onclick="pullCustomModel()"]').prop('disabled', false).text('üì• Pull Model');
        });
    }
}
</script>
{% csrf_token %}
{% endblock %}